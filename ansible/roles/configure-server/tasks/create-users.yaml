# создание групп
- name: create group
  ansible.builtin.group:
      name: "{{ item }}"
      state: present
  loop: "{{ group_list | default([]) }}"

# # создание домашних директорий пользователей
# # нужно т.к. не получается сделать так чтобы ansible НЕ создавал группу users, и не отдавал этой группу домашние директории пользователей
# - name: create user home directory
#   ansible.builtin.file:
#       path: "{{ item.value.home }}"
#       state: directory
#       owner: "{{ item.key }}"
#       group: "{{ item.key }}"
#       mode: 0750
#   loop: "{{ user_list | default({}) | dict2items }}"

# создание пользователей
- name: create user
  ansible.builtin.user:
      name: "{{ item.key }}"
      comment: "{{ item.value.comment }}"
      groups: "{{ item.value.groups }}"
      shell: "{{ item.value.shell }}"
      home: "{{ item.value.home }}"
      create_home: true
      #   move_home: true
      append: false
  loop: "{{ user_list | default({}) | dict2items }}"

- name: change owner and group of a directory
  ansible.builtin.file:
      path: "{{ item.value.home }}"
      owner: "{{ item.key }}"
      group: "{{ item.key }}"
      recurse: true
  loop: "{{ user_list | default({}) | dict2items }}"

# # TODO не нашёл как сделать так чтобы ansible НЕ добавлял пользователей в стандартную группу users
# # но удалить пользователей из неё по итогу вроде как нельзя
# - name: remove user from group
#   ansible.builtin.user:
#       name: "{{ item.key }}"
#       groups: "{{ item.value.groups | difference([ 'users' ]) }}"
#       append: no
#   loop: "{{ user_list | default({}) | dict2items }}"

# # удаление группы users создаваемой ansible-ом автоматически
# # сама группа так же не удаляется
# - name: remove group
#   ansible.builtin.group:
#       name: users
#       state: absent

# # добавление публичных ssh ключей из переменных окружения
# - name: get authorized keys from environment variable
#   ansible.posix.authorized_key:
#       user: "{{ item.key }}"
#       state: present
#       exclusive: true
#       key: "{{ lookup('env', 'PUB_' + item.key | upper, errors='ignore') }}"
#   loop: "{{ user_list | default({}) | dict2items }}"
# #   when: lookup('env', 'PUB_' + item.key | upper) != ''

- name: get authorized keys from environment variable
  ansible.posix.authorized_key:
      user: "{{ item.key }}"
      state: present
      exclusive: true
      key: "{{ lookup('env', 'PUB_' + item.key | upper, errors='ignore') }}"
  loop: "{{ user_list | default({}) | dict2items }}"
  loop_control:
      loop_var: item
#   when: lookup('env', 'PUB_' + item.key | upper, errors='ignore') | default('') != ''

# добавление публичных ssh ключей из файлов
- name: get authorized keys from files
  ansible.posix.authorized_key:
      user: "{{ item.key }}"
      state: present
      exclusive: true
      key: "{{ lookup('file', '../roles/configure-server/files/' + item.key + '.pub', errors='ignore') }}"
  loop: "{{ user_list | default({}) | dict2items }}"

- name: find home directories
  ansible.builtin.find:
      paths: /home
      file_type: directory
  register: home_directories

- name: add .bash_aliases for managed users
  ansible.builtin.template:
      src: bash_aliases.j2
      dest: "{{ item.path }}/.bash_aliases"
      mode: "0644"
      owner: "{{ item.path | basename }}"
      group: "{{ item.path | basename }}"
  loop: "{{ home_directories.files }}"

- name: add .bash_profile for managed users
  ansible.builtin.template:
      src: bash_profile.j2
      dest: "{{ item.path }}/.bash_profile"
      mode: "0644"
      owner: "{{ item.path | basename }}"
      group: "{{ item.path | basename }}"
  loop: "{{ home_directories.files }}"

# # TODO ниже варианты в которых не получилось сделать так чтобы строка не добавлялась повторно,
# # когда она уже добавлялась ранее, пока пусть побудут здесь
# - name: add paths to .bashrc
#   ansible.builtin.lineinfile:
#       path: "{{ item.path }}/.bashrc"
#       line: |

#           {% for path in app_paths %}
#           export PATH="$PATH:{{ path }}"
#           {% endfor %}
#       create: true
#       state: present
#   loop: "{{ home_directories.files }}"

# - name: form app paths content
#   ansible.builtin.set_fact:
#       app_paths_content: |

#           {% for path in app_paths %}
#           export PATH="$PATH:{{ path }}"
#           {% endfor %}

# - name: add paths to .bashrc
#   ansible.builtin.lineinfile:
#       path: "{{ item.path }}/.bashrc"
#       line: "{{ app_paths_content }}"
#       insertafter: "^    . /etc/bash_completion\n  fi\nfi$"
#       create: true
#       state: present
#   loop: "{{ home_directories.files }}"
