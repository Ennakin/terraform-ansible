# создание групп
- name: create group
  ansible.builtin.group:
      name: "{{ item }}"
      state: present
  loop: "{{ group_list | default([]) }}"

# создание пользователей
- name: create user
  ansible.builtin.user:
      name: "{{ item.key }}"
      comment: "{{ item.value.comment }}"
      groups: "{{ item.value.groups }}"
      shell: "{{ item.value.shell }}"
      home: "{{ item.value.home }}"
      create_home: true
      append: false
  loop: "{{ user_list | default({}) | dict2items }}"

# добавление публичных ssh ключей
- name: get authorized keys from file or environment variable
  ansible.posix.authorized_key:
      user: "{{ item.key }}"
      state: present
      exclusive: true
      key: "{{ lookup('env', 'PUB' + item.key | upper, default='') | default(lookup('file', item.key + '.pub', errors='omit') | default('')) }}"
  loop: "{{ user_list | default({}) | dict2items }}"
  when: lookup('env', 'PUB' + item.key | upper, default='') != '' or lookup('file', item.key + '.pub', errors='omit') | default('') != ''
