- name: check if /dev/vdb1 is in /etc/fstab
  ansible.builtin.command: grep -q '/dev/vdb1' /etc/fstab
  register: fstab_check
  ignore_errors: true

- name: perform disk setup if /dev/vdb1 is not in /etc/fstab
  block:
      - name: perform disk
        ansible.builtin.parted:
            device: /dev/vdb
            number: 1
            state: present
            align: optimal
            part_end: 100%
  when: not fstab_check.stdout

- name: create ext4 filesystem on /dev/vdb1
  block:
      - name: create ext4 filesystem
        ansible.builtin.filesystem:
            fstype: ext4
            dev: /dev/vdb1
  when: not fstab_check.stdout

- name: create mount point
  block:
      - name: create mount point
        ansible.builtin.file:
            path: /mnt/hrlink
            state: directory

  when: not fstab_check.stdout

- name: mount /dev/vdb1 to /mnt/hrlink
  block:
      - name: mount /dev/vdb1 to /mnt/hrlink
        ansible.builtin.mount:
            src: /dev/vdb1
            path: /mnt/hrlink
            fstype: ext4
            state: mounted
            opts: defaults,nofail
  when: not fstab_check.stdout

# # в таске выше добавление происходит автоматически
# - name: add entry to /etc/fstab
#   block:
#       - name: add entry to /etc/fstab
#         ansible.builtin.lineinfile:
#             path: /etc/fstab
#             line: "UUID={{ disk_uuid }} /mnt/hrlink ext4 defaults 0 2"
#             create: true
#   when: not fstab_check.stdout
